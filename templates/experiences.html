
{% extends "base.html" %}

{% block title %}Graduate Experiences{% if company %} at {{ company }}{% endif %} – Gradvantage{% endblock %}

{% block content %}
<div class="container py-5">
  <!-- Header Section -->
  <div class="text-center mb-5">
    {% if company %}
      <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb justify-content-center">
          <li class="breadcrumb-item"><a href="/companies" class="text-decoration-none">Companies</a></li>
          <li class="breadcrumb-item active">{{ company }}</li>
        </ol>
      </nav>
      <h1 class="display-4 fw-bold mb-3">{{ company }} Stories</h1>
      <p class="fs-5 text-muted">Real graduate experiences shared by our community</p>
    {% else %}
      <h1 class="display-4 fw-bold mb-3">Graduate Stories</h1>
      <p class="fs-5 text-muted">Authentic experiences from graduates across Australia's top firms</p>
    {% endif %}
  </div>

  <!-- Search and Filter Section -->
  <div class="row mb-5">
    <div class="col-lg-10 mx-auto">
      <div class="card shadow-sm border-0">
        <div class="card-body p-4">
          <div class="row g-3">
            <div class="col-md-5">
              <div class="position-relative">
                <i class="bi bi-search position-absolute top-50 start-0 translate-middle-y ms-3 text-muted"></i>
                <input type="text" class="form-control ps-5" id="searchInput" placeholder="Search by company, role, university...">
              </div>
            </div>
            <div class="col-md-7">
              <select class="form-select" id="themeFilter">
                <option value="">All Experiences</option>
                <option value="Programs">Programs</option>
                <option value="Applications">Applications</option>
                <option value="Interviews">Interviews</option>
                <option value="Salaries">Salaries</option>
                <option value="Start Dates">Start Dates</option>
                <option value="Offers & Rejections">Offers & Rejections</option>
                <option value="Firm Culture">Firm Culture</option>
                <option value="Practice Areas">Practice Areas</option>
                <option value="Locations">Locations</option>
                <option value="Other">Other</option>
              </select>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Stories Grid -->
  {% if experiences %}
    <div class="row g-4" id="experiencesContainer">
      {% for exp in experiences %}
      <div class="col-lg-6 story-card" 
           data-company="{{ exp.get('company', exp.get('firm_name', '')) }}" 
           data-role="{{ exp.get('role', '') }}" 
           data-content="{{ exp.get('content', '') }}"
           data-theme="{{ exp.get('theme', exp.get('primary_cat', '')) }}"
           data-experience-type="{{ exp.get('experience_type', '') }}"
           data-primary-cat="{{ exp.get('primary_cat', '') }}">
        
        <div class="card h-100 shadow-sm border-0 rounded-4 overflow-hidden story-card-modern">
          <!-- Story Header -->
          <div class="story-header p-4 bg-white border-bottom">
            <div class="d-flex align-items-start justify-content-between mb-3">
              <div class="flex-grow-1">
                <div class="d-flex align-items-center mb-2">
                  <div class="story-avatar bg-primary text-white rounded-circle me-3 d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                    <i class="bi bi-person fs-5"></i>
                  </div>
                  <div>
                    <h5 class="mb-1 fw-bold text-dark">
                      {{ exp.get('role', 'Graduate Program') }}
                    </h5>
                    <div class="text-muted">
                      <strong>{{ exp.get('company', exp.get('firm_name', 'Law Firm')) }}</strong>
                      {% if exp.get('experience_type') %}
                        • {{ exp.experience_type }}
                      {% endif %}
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Story Type Badge -->
              {% if exp.get('is_submission') %}
                <span class="badge bg-primary text-white px-3 py-2 fw-medium rounded-pill">
                  <i class="bi bi-chat-heart me-1"></i>Story
                </span>
              {% else %}
                <span class="badge bg-success text-white px-3 py-2 fw-medium rounded-pill">
                  <i class="bi bi-lightbulb me-1"></i>Experience
                </span>
              {% endif %}
            </div>
          </div>

          <!-- Story Content -->
          <div class="card-body p-4">
            <!-- Theme Badge -->
            {% if exp.get('cat_labels') %}
            <div class="mb-3">
              <div class="d-flex flex-wrap gap-2">
                {% for label in exp.cat_labels %}
                  <span class="badge bg-primary text-white px-3 py-2 fw-medium rounded-pill">
                    <i class="bi bi-tag me-1"></i>{{ label }}
                  </span>
                {% endfor %}
              </div>
            </div>
            {% endif %}
            
            <!-- Main Story Content -->
            {% if exp.get('content') %}
            <div class="story-main-content mb-4">
              <div class="story-text-content text-dark lh-base">
                {% set content_lines = exp.content.split('•') %}
                {% if content_lines|length > 1 %}
                  <p class="mb-3 fw-medium">{{ content_lines[0].strip() }}</p>
                  {% for line in content_lines[1:] %}
                    {% if line.strip() %}
                      <div class="mb-2 d-flex align-items-start">
                        <i class="bi bi-check-circle text-success me-2 mt-1 flex-shrink-0"></i>
                        <span>{{ line.strip() }}</span>
                      </div>
                    {% endif %}
                  {% endfor %}
                {% else %}
                  <p class="mb-0">{{ exp.content }}</p>
                {% endif %}
              </div>
            </div>
            {% endif %}
            
            <!-- Process Information -->
            {% if exp.get('application_stages') or exp.get('interview_experience') %}
            <div class="story-process mb-4">
              <div class="bg-light rounded-3 p-3 border-start border-primary border-3">
                <h6 class="text-primary fw-semibold mb-3 d-flex align-items-center">
                  <i class="bi bi-route me-2"></i>Application Journey
                </h6>
                
                {% if exp.get('application_stages') %}
                <div class="application-timeline mb-3">
                  <div class="small fw-medium text-dark mb-2 d-flex align-items-center">
                    <i class="bi bi-diagram-3 me-1 text-primary"></i>Application Process
                  </div>
                  <div class="timeline-container">
                    {% set stages = exp.application_stages.split('→') if '→' in exp.application_stages else exp.application_stages.split('-') if '-' in exp.application_stages else [exp.application_stages] %}
                    <div class="row g-2">
                      {% for stage in stages %}
                      <div class="col-auto">
                        <div class="timeline-step">
                          <div class="timeline-step-icon">
                            {% if loop.index == 1 %}
                              <i class="bi bi-file-text"></i>
                            {% elif 'interview' in stage.lower() or 'assess' in stage.lower() %}
                              <i class="bi bi-person-video2"></i>
                            {% elif 'offer' in stage.lower() or 'accept' in stage.lower() %}
                              <i class="bi bi-check-circle"></i>
                            {% elif 'reject' in stage.lower() or 'fail' in stage.lower() %}
                              <i class="bi bi-x-circle"></i>
                            {% else %}
                              <i class="bi bi-arrow-right-circle"></i>
                            {% endif %}
                          </div>
                          <div class="timeline-step-content">
                            <small class="text-muted fw-medium">{{ stage.strip() }}</small>
                          </div>
                        </div>
                      </div>
                      {% if not loop.last %}
                      <div class="col-auto d-flex align-items-center">
                        <i class="bi bi-chevron-right text-muted small"></i>
                      </div>
                      {% endif %}
                      {% endfor %}
                    </div>
                  </div>
                </div>
                {% endif %}
                
                {% if exp.get('interview_experience') %}
                <div class="interview-experience mb-0">
                  <div class="small fw-medium text-dark mb-2 d-flex align-items-center">
                    <i class="bi bi-chat-dots me-1 text-success"></i>Interview Experience
                  </div>
                  <div class="interview-content bg-white rounded-2 p-3 border">
                    <p class="small text-muted mb-0 lh-base">{{ exp.interview_experience }}</p>
                  </div>
                </div>
                {% endif %}
              </div>
            </div>
            {% endif %}
            
            <!-- Key Advice -->
            {% if exp.get('advice') %}
            <div class="story-advice mb-4">
              <div class="bg-light rounded-3 p-3 border-start border-warning border-3">
                <div class="d-flex align-items-start">
                  <i class="bi bi-lightbulb-fill text-warning me-2 mt-1 flex-shrink-0"></i>
                  <div>
                    <h6 class="text-warning fw-semibold mb-1">Pro Tip</h6>
                    <p class="mb-0 small text-dark">{{ exp.advice }}</p>
                  </div>
                </div>
              </div>
            </div>
            {% endif %}
            
            <!-- Tags -->
            {% if exp.get('cat_labels') %}
            <div class="story-tags">
              <div class="d-flex flex-wrap gap-2">
                {% for label in exp.cat_labels %}
                  <span class="badge bg-light text-dark border small">{{ label }}</span>
                {% endfor %}
              </div>
            </div>
            {% endif %}
          </div>

          <!-- Story Footer -->
          <div class="card-footer bg-light border-0 p-3">
            <div class="d-flex justify-content-between align-items-center">
              <div class="story-meta d-flex align-items-center gap-3">
                <span class="text-muted small">
                  <i class="bi bi-clock me-1"></i>Recently shared
                </span>
              </div>
              
              <div class="story-actions d-flex gap-2">
                <button class="btn btn-sm btn-outline-primary rounded-pill px-3" title="Helpful">
                  <i class="bi bi-hand-thumbs-up me-1"></i>Helpful
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>

    <!-- Load More Button -->
    <div class="text-center mt-5">
      <button class="btn btn-outline-primary btn-lg px-4" id="loadMoreBtn">
        <i class="bi bi-arrow-down-circle me-2"></i>Load More Stories
      </button>
    </div>

  {% else %}
    <!-- Empty State -->
    <div class="empty-state text-center py-5">
      <div class="mb-4">
        <i class="bi bi-chat-square-text text-muted" style="font-size: 4rem;"></i>
      </div>
      <h4 class="fw-medium mb-3">No stories yet{% if company %} for {{ company }}{% endif %}</h4>
      <p class="text-muted mb-4">Be the first to share your graduate experience and help build our community!</p>
      <a href="/submit" class="btn btn-primary btn-lg px-4">
        <i class="bi bi-plus-circle me-2"></i>Share Your Story
      </a>
    </div>
  {% endif %}
</div>

<!-- JavaScript for Search and Filter -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('searchInput');
    const themeFilter = document.getElementById('themeFilter');
    const storyCards = document.querySelectorAll('.story-card');
    const loadMoreBtn = document.getElementById('loadMoreBtn');
    
    let visibleCards = 6;
    
    function updateCardVisibility() {
        storyCards.forEach((card, index) => {
            if (index < visibleCards) {
                card.style.display = card.dataset.visible !== 'false' ? 'block' : 'none';
            } else {
                card.style.display = 'none';
            }
        });
        
        if (loadMoreBtn) {
            const visibleCount = Array.from(storyCards).filter(card => card.dataset.visible !== 'false').length;
            loadMoreBtn.style.display = visibleCards >= visibleCount ? 'none' : 'block';
        }
    }

    function filterStories() {
        const searchTerm = searchInput.value.toLowerCase();
        const selectedTheme = themeFilter.value.toLowerCase();

        storyCards.forEach(card => {
            const company = card.dataset.company.toLowerCase();
            const role = card.dataset.role.toLowerCase();
            const content = card.dataset.content.toLowerCase();
            const theme = card.dataset.theme ? card.dataset.theme.toLowerCase() : '';
            const primaryCat = card.dataset.primaryCat ? card.dataset.primaryCat.toLowerCase() : '';

            const matchesSearch = !searchTerm || 
                                company.includes(searchTerm) || 
                                role.includes(searchTerm) || 
                                content.includes(searchTerm);
            
            // Show all experiences by default, filter by theme only if one is selected
            const matchesTheme = !selectedTheme || 
                               theme.includes(selectedTheme) || 
                               primaryCat.includes(selectedTheme);

            if (matchesSearch && matchesTheme) {
                card.dataset.visible = 'true';
                card.classList.add('fade-in');
            } else {
                card.dataset.visible = 'false';
                card.classList.remove('fade-in');
            }
        });
        
        visibleCards = 6;
        updateCardVisibility();
    }

    if (searchInput) {
        searchInput.addEventListener('input', filterStories);
    }
    
    if (themeFilter) {
        themeFilter.addEventListener('change', filterStories);
    }
    
    if (loadMoreBtn) {
        loadMoreBtn.addEventListener('click', function() {
            visibleCards += 6;
            updateCardVisibility();
        });
    }
    
    updateCardVisibility();
});
</script>
{% endblock %}
