{% extends "base.html" %}

{% block title %}{{ company }} Stories – Gradvantage{% endblock %}

{% block content %}
<div class="container py-5">
  <!-- Header Section -->
  {% if company_title %}
    {% set analytics_slug = (company_slug or company_title)|lower|replace('&', 'and')|replace(' & ', '-and-')|replace(' ', '-') %}
    <div class="page-hero company-hero mb-5">
      <div>
        <nav aria-label="breadcrumb" class="mb-3">
          <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/companies" class="text-decoration-none">Companies</a></li>
            <li class="breadcrumb-item active">{{ company_title }}</li>
          </ol>
        </nav>
        <h1 class="page-title display-4 fw-bold mb-2">{{ company_title }}</h1>
        <p class="page-sub fs-5 text-muted">Graduate stories</p>
      </div>
      <a class="btn-primary-custom" href="/company/{{ company_title | urlencode }}#analytics">
        <i class="bi bi-bar-chart me-2"></i>View Analytics
      </a>
    </div>
  {% else %}
    <div class="text-center mb-5">
      <h1 class="display-4 fw-bold mb-3">Graduate Stories</h1>
      <p class="fs-5 text-muted">Authentic experiences from graduates across Australia's top firms</p>
    </div>
  {% endif %}

  <!-- Analytics Section (Collapsible) -->
  <div class="collapse mb-5" id="analyticsSection">
    <div class="card shadow-sm border-0">
      <div class="card-header bg-light py-3">
        <h5 class="mb-0 fw-bold text-primary d-flex align-items-center">
          <i class="bi bi-bar-chart-line-fill me-2"></i>Analytics for {{ company }}
        </h5>
      </div>
      <div class="card-body" id="firm-analytics-detailed">
        <p class="text-muted text-center">Loading analytics...</p>
      </div>
    </div>
  </div>

  <!-- Search and Filter Section -->
  <div class="row mb-5">
    <div class="col-lg-10 mx-auto">
      <div class="card shadow-sm border-0">
        <div class="card-body p-4">
          <div class="row g-3">
            <div class="col-md-5">
              <div class="position-relative">
                <i class="bi bi-search position-absolute top-50 start-0 translate-middle-y ms-3 text-muted"></i>
                <input type="text" class="form-control ps-5" id="searchInput" placeholder="Search by company, role, university...">
              </div>
            </div>
            <div class="col-md-7">
              <select class="form-select" id="themeFilter">
                <option value="">All Experiences</option>
                <option value="Programs">Programs</option>
                <option value="Applications">Applications</option>
                <option value="Interviews">Interviews</option>
                <option value="Salaries">Salaries</option>
                <option value="Start Dates">Start Dates</option>
                <option value="Offers & Rejections">Offers & Rejections</option>
                <option value="Firm Culture">Firm Culture</option>
                <option value="Practice Areas">Practice Areas</option>
                <option value="Locations">Locations</option>
                <option value="Other">Other</option>
              </select>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Stories Grid -->
  {% if experiences %}
    <div class="row g-4" id="experiencesContainer">
      {% for exp in experiences %}
      <div class="col-lg-6 story-card" 
           data-company="{{ exp.get('company', exp.get('firm_name', '')) }}" 
           data-role="{{ exp.get('role', '') }}" 
           data-content="{{ exp.get('content', '') }}"
           data-theme="{{ exp.get('theme', exp.get('primary_cat', '')) }}"
           data-experience-type="{{ exp.get('experience_type', '') }}"
           data-primary-cat="{{ exp.get('primary_cat', '') }}">

        <div class="card h-100 shadow-sm border-0 rounded-4 overflow-hidden story-card-modern">
          <!-- Story Header -->
          <div class="story-header p-4 bg-white border-bottom">
            <div class="d-flex align-items-start justify-content-between mb-3">
              <div class="flex-grow-1">
                <div class="d-flex align-items-center mb-2">
                  <div class="story-avatar bg-primary text-white rounded-circle me-3 d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                    <i class="bi bi-person fs-5"></i>
                  </div>
                  <div>
                    <h5 class="mb-1 fw-bold text-dark">
                      {{ exp.get('role', 'Graduate Program') }}
                    </h5>
                    <div class="text-muted">
                      <strong>{{ exp.get('company', exp.get('firm_name', 'Law Firm')) }}</strong>
                      {% if exp.get('experience_type') %}
                        • {{ exp.experience_type }}
                      {% endif %}
                    </div>
                  </div>
                </div>
              </div>

              <!-- Story Type Badge -->
              {% if exp.get('is_submission') %}
                <span class="badge bg-primary text-white px-3 py-2 fw-medium rounded-pill">
                  <i class="bi bi-chat-heart me-1"></i>Story
                </span>
              {% else %}
                <span class="badge bg-success text-white px-3 py-2 fw-medium rounded-pill">
                  <i class="bi bi-lightbulb me-1"></i>Experience
                </span>
              {% endif %}
            </div>
          </div>

          <!-- Story Content -->
          <div class="card-body p-4">
            <!-- Theme Badge -->
            {% if exp.get('cat_labels') %}
            <div class="mb-3">
              <div class="d-flex flex-wrap gap-2">
                {% for label in exp.cat_labels %}
                  <span class="badge bg-primary text-white px-3 py-2 fw-medium rounded-pill">
                    <i class="bi bi-tag me-1"></i>{{ label }}
                  </span>
                {% endfor %}
              </div>
            </div>
            {% endif %}

            <!-- Main Story Content -->
            {% if exp.get('content') %}
            <div class="story-main-content mb-4">
              <div class="story-text-content text-dark lh-base">
                {% set content_lines = exp.content.split('•') %}
                {% if content_lines|length > 1 %}
                  <p class="mb-3 fw-medium">{{ content_lines[0].strip() }}</p>
                  {% for line in content_lines[1:] %}
                    {% if line.strip() %}
                      <div class="mb-2 d-flex align-items-start">
                        <i class="bi bi-check-circle text-success me-2 mt-1 flex-shrink-0"></i>
                        <span>{{ line.strip() }}</span>
                      </div>
                    {% endif %}
                  {% endfor %}
                {% else %}
                  <p class="mb-0">{{ exp.content }}</p>
                {% endif %}
              </div>
            </div>
            {% endif %}

            <!-- Process Information -->
            {% if exp.get('application_stages') or exp.get('interview_experience') %}
            <div class="story-process mb-4">
              <div class="bg-light rounded-3 p-3 border-start border-primary border-3">
                <h6 class="text-primary fw-semibold mb-3 d-flex align-items-center">
                  <i class="bi bi-route me-2"></i>Application Journey
                </h6>

                {# Application process — Subway Stepper #}
                {% set raw = (exp.get('application_process') or exp.get('application_stages') or '') %}
                {% set steps = raw.replace('Application process:', '').replace('application process:', '') %}
                {% set steps = steps.replace('→','|').replace('->','|').split('|') %}
                {% set steps = steps | map('trim') | reject('equalto','') | list %}

                {% if steps %}
                <div class="appflow">
                  <div class="flow-head">
                    <span class="flow-title">Application process</span>
                    <span class="flow-meta">{{ steps|length }} steps</span>
                  </div>

                  <ol class="flow-rail" role="list">
                    {% for s in steps %}
                      <li class="flow-stop">
                        <span class="flow-dot">{{ loop.index }}</span>
                        <span class="flow-label">{{ s }}</span>
                      </li>
                    {% endfor %}
                  </ol>
                </div>
                {% endif %}
              </div>
            </div>
            {% endif %}

            <!-- Pro Tip -->
            {% if exp.get('pro_tip') and exp.pro_tip.strip() %}
            <div class="story-pro-tip mb-4">
              <div class="bg-primary-subtle rounded-3 p-3 border-start border-primary border-3">
                <div class="d-flex align-items-start">
                  <i class="bi bi-star-fill me-2 mt-1 flex-shrink-0" style="color: #ffd700;"></i>
                  <div>
                    <h6 class="text-primary fw-semibold mb-1">Pro Tip ✨</h6>
                    <p class="mb-0 small text-dark fw-medium">{{ exp.pro_tip }}</p>
                  </div>
                </div>
              </div>
            </div>
            {% endif %}

            <!-- Key Advice -->
            {% if exp.get('advice') %}
            <div class="story-advice mb-4">
              <div class="bg-light rounded-3 p-3 border-start border-warning border-3">
                <div class="d-flex align-items-start">
                  <i class="bi bi-lightbulb-fill text-warning me-2 mt-1 flex-shrink-0"></i>
                  <div>
                    <h6 class="text-warning fw-semibold mb-1">Advice</h6>
                    <p class="mb-0 small text-dark">{{ exp.advice }}</p>
                  </div>
                </div>
              </div>
            </div>
            {% endif %}

            <!-- Tags -->
            {% if exp.get('cat_labels') %}
            <div class="story-tags">
              <div class="d-flex flex-wrap gap-2">
                {% for label in exp.cat_labels %}
                  <span class="badge bg-light text-dark border small">{{ label }}</span>
                {% endfor %}
              </div>
            </div>
            {% endif %}
          </div>

          <!-- Story Footer -->
          <div class="card-footer bg-light border-0 p-3">
            <div class="d-flex justify-content-between align-items-center">
              <div class="story-meta d-flex align-items-center gap-3">
                <span class="text-muted small">
                  <i class="bi bi-clock me-1"></i>Recently shared
                </span>
              </div>

              <div class="story-actions d-flex gap-2">
                <button class="btn btn-sm btn-outline-primary rounded-pill px-3" title="Helpful">
                  <i class="bi bi-hand-thumbs-up me-1"></i>Helpful
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>

    <!-- Load More Button -->
    <div class="text-center mt-5">
      <button class="btn btn-outline-primary btn-lg px-4" id="loadMoreBtn">
        <i class="bi bi-arrow-down-circle me-2"></i>Load More Stories
      </button>
    </div>

  {% else %}
    <!-- Empty State -->
    <div class="empty-state text-center py-5">
      <div class="mb-4">
        <i class="bi bi-chat-square-text text-muted" style="font-size: 4rem;"></i>
      </div>
      <h4 class="fw-medium mb-3">No stories yet{% if company %} for {{ company }}{% endif %}</h4>
      <p class="text-muted mb-4">Be the first to share your graduate experience and help build our community!</p>
      <a href="/submit" class="btn btn-primary btn-lg px-4">
        <i class="bi bi-plus-circle me-2"></i>Share Your Story
      </a>
    </div>
  {% endif %}
</div>

<!-- JavaScript for Search and Filter -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('searchInput');
    const themeFilter = document.getElementById('themeFilter');
    const storyCards = document.querySelectorAll('.story-card');
    const loadMoreBtn = document.getElementById('loadMoreBtn');

    let visibleCards = 6;

    function updateCardVisibility() {
        storyCards.forEach((card, index) => {
            if (index < visibleCards) {
                card.style.display = card.dataset.visible !== 'false' ? 'block' : 'none';
            } else {
                card.style.display = 'none';
            }
        });

        if (loadMoreBtn) {
            const visibleCount = Array.from(storyCards).filter(card => card.dataset.visible !== 'false').length;
            loadMoreBtn.style.display = visibleCards >= visibleCount ? 'none' : 'block';
        }
    }

    function filterStories() {
        const searchTerm = searchInput.value.toLowerCase();
        const selectedTheme = themeFilter.value.toLowerCase();

        storyCards.forEach(card => {
            const company = card.dataset.company.toLowerCase();
            const role = card.dataset.role.toLowerCase();
            const content = card.dataset.content.toLowerCase();
            const theme = card.dataset.theme ? card.dataset.theme.toLowerCase() : '';
            const primaryCat = card.dataset.primaryCat ? card.dataset.primaryCat.toLowerCase() : '';

            const matchesSearch = !searchTerm || 
                                company.includes(searchTerm) || 
                                role.includes(searchTerm) || 
                                content.includes(searchTerm);

            // Show all experiences by default, filter by theme only if one is selected
            const matchesTheme = !selectedTheme || 
                               theme.includes(selectedTheme) || 
                               primaryCat.includes(selectedTheme);

            if (matchesSearch && matchesTheme) {
                card.dataset.visible = 'true';
                card.classList.add('fade-in');
            } else {
                card.dataset.visible = 'false';
                card.classList.remove('fade-in');
            }
        });

        visibleCards = 6;
        updateCardVisibility();
    }

    if (searchInput) {
        searchInput.addEventListener('input', filterStories);
    }

    if (themeFilter) {
        themeFilter.addEventListener('change', filterStories);
    }

    if (loadMoreBtn) {
        loadMoreBtn.addEventListener('click', function() {
            visibleCards += 6;
            updateCardVisibility();
        });
    }

    updateCardVisibility();
});
</script>
<script>
// Load firm-specific analytics when analytics section is expanded
document.addEventListener('DOMContentLoaded', function() {
  const firmName = "{{ company }}"; // Use 'company' variable from the template context

  if (firmName) {
    // Load analytics when the collapsible section is shown
    const analyticsSection = document.getElementById('analyticsSection');
    if (analyticsSection) {
      analyticsSection.addEventListener('show.bs.collapse', function() {
        loadFirmAnalytics(firmName);
      });
    }

    function loadFirmAnalytics(companyName) {
      const analyticsDiv = document.getElementById('firm-analytics-detailed');
      if (!analyticsDiv) return; // Exit if the div doesn't exist

      analyticsDiv.innerHTML = '<p class="text-muted text-center">Loading analytics...</p>'; // Show loading indicator

      fetch('/api/company-analytics/' + encodeURIComponent(companyName))
        .then(response => {
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          return response.json();
        })
        .then(data => {
          if (data.error) {
            analyticsDiv.innerHTML = '<p class="text-muted text-center">No analytics data available for this company yet.</p>';
            return;
          }

          let html = '<div class="row g-4">';

          // Company stats
          if (data.company_stats) {
            html += `
              <div class="col-md-6">
                <div class="card border-0 bg-primary bg-opacity-10">
                  <div class="card-body">
                    <h6 class="fw-semibold mb-3 text-primary">
                      <i class="bi bi-speedometer2 me-1"></i>Application Performance
                    </h6>
                    <div class="row g-3">
                      <div class="col-6">
                        <div class="text-center p-3 bg-white rounded">
                          <div class="fw-bold text-primary fs-5">${data.company_stats.response_rate}%</div>
                          <small class="text-muted">Response Rate</small>
                        </div>
                      </div>
                      <div class="col-6">
                        <div class="text-center p-3 bg-white rounded">
                          <div class="fw-bold text-success fs-5">${data.company_stats.offer_rate}%</div>
                          <small class="text-muted">Offer Rate</small>
                        </div>
                      </div>
                      <div class="col-6">
                        <div class="text-center p-3 bg-white rounded">
                          <div class="fw-bold text-info fs-5">${data.company_stats.avg_response_time}</div>
                          <small class="text-muted">Avg Response (days)</small>
                        </div>
                      </div>
                      <div class="col-6">
                        <div class="text-center p-3 bg-white rounded">
                          <div class="fw-bold text-secondary fs-5">${data.company_stats.total_apps}</div>
                          <small class="text-muted">Total Applications</small>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            `;
          }

          // University progression
          if (data.university_progression && Object.keys(data.university_progression).length > 0) {
            html += `
              <div class="col-md-6">
                <div class="card border-0 bg-success bg-opacity-10">
                  <div class="card-body">
                    <h6 class="fw-semibold mb-3 text-success">
                      <i class="bi bi-mortarboard me-1"></i>University Success Rates
                    </h6>
            `;

            // Sort universities by offer rate and show top 5
            const sortedUnis = Object.entries(data.university_progression)
              .sort(([,a], [,b]) => b.offer_rate - a.offer_rate)
              .slice(0, 5);

            sortedUnis.forEach(([uni, stats]) => {
              html += `
                <div class="mb-3 p-3 bg-white rounded">
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="fw-medium small">${uni}</span>
                    <span class="badge bg-success">${stats.offer_rate}%</span>
                  </div>
                  <div class="small text-muted mb-2">${stats.total_apps} applications tracked</div>
                  <div class="row g-2 text-center">
                    <div class="col-4">
                      <div class="small fw-medium text-warning">${stats.assessment_rate}%</div>
                      <div class="small text-muted">Assessments</div>
                    </div>
                    <div class="col-4">
                      <div class="small fw-medium text-info">${stats.interview_rate}%</div>
                      <div class="small text-muted">Interviews</div>
                    </div>
                    <div class="col-4">
                      <div class="small fw-medium text-success">${stats.offer_rate}%</div>
                      <div class="small text-muted">Offers</div>
                    </div>
                  </div>
                </div>
              `;
            });

            html += `
                  </div>
                </div>
              </div>
            `;
          }

          html += '</div>';

          if (!data.company_stats && (!data.university_progression || Object.keys(data.university_progression).length === 0)) {
            html = '<p class="text-muted text-center">No application tracking data available for this company yet.</p>';
          }

          analyticsDiv.innerHTML = html;
        })
        .catch(error => {
          console.error('Error loading analytics:', error);
          analyticsDiv.innerHTML = '<p class="text-muted text-center">Unable to load analytics data.</p>';
        });
    }
  } else {
    // If no company name is provided, show a message
    const analyticsDiv = document.getElementById('firm-analytics-detailed');
    if (analyticsDiv) {
      analyticsDiv.innerHTML = '<p class="text-muted text-center">Please select a company to view analytics.</p>';
    }
  }
});
</script>
{% endblock %}