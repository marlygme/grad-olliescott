{% extends "base.html" %}

{% block title %}Share Your Experience â€“ Gradvantage{% endblock %}

{% block content %}
<div class="hero-section">
  <div class="container text-center">
    <h1 class="hero-title">Share Your Graduate Experience</h1>
    <p class="hero-subtitle">Help other students by sharing your application journey</p>
  </div>
</div>

<div class="container my-5">
  {% if user_id %}
  <div class="alert alert-success mb-4">
    <i class="bi bi-check-circle me-2"></i>
    Welcome, {{ user_name }}! You're logged in and ready to share your story.
  </div>
  <form method="POST" class="row g-3">
    <div class="col-md-6">
      <label class="form-label">Company</label>
      <input id="company" name="company" class="form-control" required>
    </div>
    <div class="col-md-6">
      <label class="form-label">Role</label>
      <input name="role" class="form-control" required>
    </div>
    <div class="col-md-6">
      <label class="form-label">Experience Type</label>
      <select id="experience_type" name="experience_type" class="form-select" required>
        <option value="">Select type</option>
        <option value="Graduate Program">Graduate Program</option>
        <option value="Internship">Internship</option>
        <option value="Clerkship">Clerkship</option>
        <option value="Vacation Work">Vacation Work</option>
        <option value="Entry Level">Entry Level</option>
      </select>
    </div>
    <div class="col-md-6">
      <button type="button" id="btn-autofill" class="btn btn-info btn-sm mt-4">
        <i class="bi bi-magic me-1"></i>Use data-assisted draft
      </button>
      <small class="text-muted d-block">Auto-fill from CSV data</small>
    </div>
    <div class="col-md-12">
      <label class="form-label">Key Theme</label>
      <select id="theme" name="theme" class="form-select" required>
        <option value="">Select theme</option>
        <option value="application_timeline">Application timeline</option>
        <option value="selection_process">Selection process</option>
        <option value="offer_outcomes">Offer outcomes</option>
        <option value="program_structure">Program structure</option>
        <option value="pay_benefits">Pay & benefits</option>
        <option value="hours_workload">Hours & workload</option>
        <option value="culture_environment">Culture & environment</option>
        <option value="training_support">Training & support</option>
        <option value="secondments_mobility">Secondments & mobility</option>
        <option value="eligibility_requirements">Eligibility & requirements</option>
        <option value="interview_tips">Interview tips</option>
      </select>
    </div>
    <div class="col-12" id="dynamic-fields">
      <!-- Dynamic fields will be inserted here based on theme selection -->
    </div>

    <script>
      document.addEventListener('DOMContentLoaded', function() {
        const themeSelect = document.querySelector('select[name="theme"]');
        const dynamicFields = document.getElementById('dynamic-fields');

        const fieldTemplates = {
          'application_timeline': `
            <div class="mb-3">
              <label class="form-label">Application Timeline Details</label>
              <textarea name="application_stages" class="form-control" rows="3" placeholder="When did applications open/close? What were the key dates and deadlines?"></textarea>
            </div>
            <div class="mb-3">
              <label class="form-label">Timeline Tips</label>
              <textarea name="advice" class="form-control" rows="2" placeholder="Any advice about timing, deadlines, or when to apply?"></textarea>
            </div>
          `,
          'selection_process': `
            <div class="mb-3">
              <label class="form-label">Selection Process Stages</label>
              <textarea name="application_stages" class="form-control" rows="3" placeholder="Describe each stage: online application, tests, interviews, assessment centre, etc."></textarea>
            </div>
            <div class="mb-3">
              <label class="form-label">What to Expect</label>
              <textarea name="interview_experience" class="form-control" rows="3" placeholder="What should candidates expect at each stage? Any surprises or unique elements?"></textarea>
            </div>
          `,
          'offer_outcomes': `
            <div class="mb-3">
              <label class="form-label">Offer Details</label>
              <textarea name="application_stages" class="form-control" rows="2" placeholder="When did you hear back? How was the offer communicated?"></textarea>
            </div>
            <div class="mb-3">
              <label class="form-label">Outcome Experience</label>
              <textarea name="interview_experience" class="form-control" rows="3" placeholder="Describe your experience receiving the outcome (offer/rejection). Any negotiation?"></textarea>
            </div>
          `,
          'program_structure': `
            <div class="mb-3">
              <label class="form-label">Program Structure</label>
              <textarea name="application_stages" class="form-control" rows="3" placeholder="How many rotations? What practice areas? Program length and structure?"></textarea>
            </div>
            <div class="mb-3">
              <label class="form-label">Rotation Experience</label>
              <textarea name="interview_experience" class="form-control" rows="3" placeholder="What were your rotations like? How do you choose seats?"></textarea>
            </div>
          `,
          'pay_benefits': `
            <div class="mb-3">
              <label class="form-label">Compensation Details</label>
              <textarea name="application_stages" class="form-control" rows="2" placeholder="Break down salary, bonuses, benefits, super, overtime rates, etc."></textarea>
            </div>
            <div class="mb-3">
              <label class="form-label">Benefits Experience</label>
              <textarea name="interview_experience" class="form-control" rows="3" placeholder="What benefits did you receive? Any hidden costs or unexpected perks?"></textarea>
            </div>
          `,
          'hours_workload': `
            <div class="mb-3">
              <label class="form-label">Hours & Workload</label>
              <textarea name="application_stages" class="form-control" rows="3" placeholder="Typical hours per day/week? Billable targets? Weekend work? Overtime expectations?"></textarea>
            </div>
            <div class="mb-3">
              <label class="form-label">Work-Life Balance</label>
              <textarea name="interview_experience" class="form-control" rows="3" placeholder="How manageable was the workload? Any tips for balancing work and life?"></textarea>
            </div>
          `,
          'culture_environment': `
            <div class="mb-3">
              <label class="form-label">Firm Culture</label>
              <textarea name="application_stages" class="form-control" rows="3" placeholder="Describe the culture, team dynamics, partner relationships, social events, etc."></textarea>
            </div>
            <div class="mb-3">
              <label class="form-label">Cultural Fit</label>
              <textarea name="interview_experience" class="form-control" rows="3" placeholder="What type of person thrives here? Any cultural challenges or highlights?"></textarea>
            </div>
          `,
          'training_support': `
            <div class="mb-3">
              <label class="form-label">Training Programs</label>
              <textarea name="application_stages" class="form-control" rows="3" placeholder="What training did you receive? Mentorship programs? PLT support?"></textarea>
            </div>
            <div class="mb-3">
              <label class="form-label">Support System</label>
              <textarea name="interview_experience" class="form-control" rows="3" placeholder="How supportive were partners/senior lawyers? Quality of mentorship and feedback?"></textarea>
            </div>
          `,
          'secondments_mobility': `
            <div class="mb-3">
              <label class="form-label">Secondment Opportunities</label>
              <textarea name="application_stages" class="form-control" rows="3" placeholder="What secondment options are available? Client secondments? International opportunities?"></textarea>
            </div>
            <div class="mb-3">
              <label class="form-label">Mobility Experience</label>
              <textarea name="interview_experience" class="form-control" rows="3" placeholder="Did you do any secondments? How do you apply? What was the experience like?"></textarea>
            </div>
          `,
          'eligibility_requirements': `
            <div class="mb-3">
              <label class="form-label">Eligibility Criteria</label>
              <textarea name="application_stages" class="form-control" rows="3" placeholder="Academic requirements, citizenship/visa requirements, year of study, etc."></textarea>
            </div>
            <div class="mb-3">
              <label class="form-label">Application Requirements</label>
              <textarea name="interview_experience" class="form-control" rows="3" placeholder="What documents were required? Any specific eligibility challenges you faced?"></textarea>
            </div>
          `,
          'interview_tips': `
            <div class="mb-3">
              <label class="form-label">Interview Questions</label>
              <textarea name="interview_experience" class="form-control" rows="4" placeholder="What questions were you asked? Behavioral, technical, case studies? Be specific with examples."></textarea>
            </div>
            <div class="mb-3">
              <label class="form-label">Interview Advice</label>
              <textarea name="advice" class="form-control" rows="3" placeholder="Your best tips for interviews at this firm. What worked? What didn't? How to prepare?"></textarea>
            </div>
          `
        };

        function updateFields() {
          const selectedTheme = themeSelect.value;
          if (selectedTheme && fieldTemplates[selectedTheme]) {
            dynamicFields.innerHTML = fieldTemplates[selectedTheme];
          } else {
            // Default fields
            dynamicFields.innerHTML = `
              <div class="mb-3">
                <label class="form-label">Application Stages</label>
                <textarea name="application_stages" class="form-control" rows="2" placeholder="Describe the application process (e.g., online application, phone screen, assessment centre, etc.)"></textarea>
              </div>
              <div class="mb-3">
                <label class="form-label">Interview Experience</label>
                <textarea name="interview_experience" class="form-control" rows="3" placeholder="What was the interview like? What questions were asked?"></textarea>
              </div>
              <div class="mb-3">
                <label class="form-label">Advice</label>
                <textarea name="advice" class="form-control" rows="3" placeholder="Any advice for future applicants?"></textarea>
              </div>
            `;
          }
        }

        // Initialize with default fields
        updateFields();

        // Update fields when theme changes
        themeSelect.addEventListener('change', updateFields);
      });

      // Data-assisted draft functionality
      async function fetchDraft(firm){
        const res = await fetch(`/api/draft?firm=${encodeURIComponent(firm)}`);
        if (!res.ok) throw new Error('No draft for firm');
        return await res.json();
      }
      function setIf(el, val){ if(el && val){ el.value = val; } }
      function selectIfHas(select, val){
        if(!select || !val) return;
        [...select.options].forEach(opt => {
          if(opt.value.toLowerCase() === String(val).toLowerCase()) select.value = opt.value;
        });
      }
      function selectMulti(select, values){
        if(!select || !values) return;
        const set = new Set(values.map(v=>String(v).toLowerCase()));
        [...select.options].forEach(opt => {
          opt.selected = set.has(opt.textContent.trim().toLowerCase()) || set.has(opt.value.toLowerCase());
        });
      }

      document.getElementById('btn-autofill')?.addEventListener('click', async () => {
        const firm = (document.getElementById('company')?.value || "").trim();
        if(!firm){ alert("Enter a company name first."); return; }
        try {
          const d = await fetchDraft(firm);
          if (d.error) throw new Error(d.error);
          
          // Update basic fields
          setIf(document.getElementById('company'), d.company);
          selectIfHas(document.getElementById('experience_type'), d.experience_type);
          
          // Auto-select appropriate theme based on data
          if (d.key_themes && d.key_themes.length > 0) {
            const themeMap = {
              'Application timeline': 'application_timeline',
              'Selection process': 'selection_process', 
              'Pay & benefits': 'pay_benefits',
              'Hours & workload': 'hours_workload',
              'Program structure': 'program_structure',
              'Training & support': 'training_support',
              'Secondments & mobility': 'secondments_mobility',
              'Eligibility & requirements': 'eligibility_requirements',
              'Culture & environment': 'culture_environment',
              'Interview tips': 'interview_tips'
            };
            const firstTheme = d.key_themes[0];
            const themeValue = themeMap[firstTheme];
            if (themeValue) {
              document.getElementById('theme').value = themeValue;
              // Trigger the change event to update dynamic fields
              document.getElementById('theme').dispatchEvent(new Event('change'));
              
              // Wait a bit for fields to be created, then fill them
              setTimeout(() => {
                // Fill dynamic fields based on theme
                const appStages = document.querySelector('textarea[name="application_stages"]');
                const interviewExp = document.querySelector('textarea[name="interview_experience"]');
                const advice = document.querySelector('textarea[name="advice"]');
                
                if (themeValue === 'selection_process' && d.process_line) {
                  setIf(appStages, d.process_line);
                }
                if (themeValue === 'pay_benefits' && d.pay_line) {
                  setIf(appStages, d.pay_line);
                }
                if (themeValue === 'hours_workload' && d.hours_line) {
                  setIf(appStages, d.hours_line);
                }
                if (themeValue === 'culture_environment' && d.culture_para) {
                  setIf(appStages, d.culture_para);
                }
                if (themeValue === 'interview_tips') {
                  setIf(interviewExp, d.tips_line);
                  setIf(advice, 'Based on forum posts: ' + (d.tips_line || 'No specific tips found'));
                }
              }, 100);
            }
          }
          
          console.log("Draft filled from", d.evidence_count, "posts");
          alert(`Draft filled from ${d.evidence_count} posts. Please review and edit before submitting.`);
        } catch (e){
          console.error(e);
          alert("Couldn't build a draft for that firm. Try a different name or check if data exists.");
        }
      });
    </script>
    <div class="col-12">
      <button type="submit" class="btn btn-primary">Submit</button>
      <a href="/" class="btn btn-outline-secondary ms-2">Cancel</a>
    </div>
  </form>
  {% else %}
  <div class="text-center py-5">
    <div class="mb-4">
      <i class="bi bi-person-lock text-primary" style="font-size: 4rem;"></i>
    </div>
    <h3 class="fw-medium mb-3">Account Required</h3>
    <p class="text-muted mb-4">Please log in with your Replit account to share your graduate experience and help other students.</p>
    <div class="mb-4">
      <button onclick="LoginWithReplit()" class="btn btn-primary btn-lg">
        <i class="bi bi-box-arrow-in-right me-2"></i>Login with Replit
      </button>
    </div>
    <script>
      function LoginWithReplit() {
        window.addEventListener("message", authComplete);
        var h = 500;
        var w = 350;
        var left = screen.width / 2 - w / 2;
        var top = screen.height / 2 - h / 2;

        var authWindow = window.open(
          "https://replit.com/auth_with_repl_site?domain=" + location.host,
          "_blank",
          "modal=yes, toolbar=no, location=no, directories=no, status=no, menubar=no, scrollbars=no, resizable=no, copyhistory=no, width=" +
            w +
            ", height=" +
            h +
            ", top=" +
            top +
            ", left=" +
            left
        );

        function authComplete(e) {
          if (e.data !== "auth_complete") {
            return;
          }

          window.removeEventListener("message", authComplete);
          authWindow.close();
          location.reload();
        }
      }
    </script>
  </div>
  {% endif %}
</div>
{% endblock %}