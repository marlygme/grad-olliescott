
{% extends "base.html" %}

{% block title %}Application Tracker â€“ Gradvantage{% endblock %}

{% block content %}
<style>
.status-container .status-display {
  cursor: pointer;
  transition: opacity 0.2s;
}
.status-container .status-display:hover {
  opacity: 0.8;
}
.status-edit {
  min-width: 200px;
}
</style>
<div class="hero-section">
  <div class="container text-center">
    <h1 class="hero-title">Track Your Applications</h1>
    <p class="hero-subtitle">Keep track of your graduate program applications and outcomes</p>
  </div>
</div>

<div class="container my-5">
  {% if user_id %}
    <!-- Add New Application -->
    <div class="card mb-4">
      <div class="card-body">
        <h4 class="card-title mb-3">Add New Application</h4>
        <form method="POST" action="/tracker/add" class="row g-3">
          <div class="col-md-4">
            <label class="form-label">Company</label>
            <input name="company" class="form-control" required>
          </div>
          <div class="col-md-4">
            <label class="form-label">Role/Program</label>
            <input name="role" class="form-control" required>
          </div>
          <div class="col-md-3">
            <label class="form-label">Application Date</label>
            <input name="application_date" type="date" class="form-control" required>
          </div>
          <div class="col-md-3">
            <label class="form-label">WAM</label>
            <input name="wam" type="number" step="0.01" class="form-control" placeholder="e.g. 78.56">
          </div>
          <div class="col-md-3">
            <label class="form-label">University</label>
            <select name="university" class="form-select" required>
              <option value="">Select university</option>
              <option value="University of Melbourne">University of Melbourne</option>
              <option value="Monash University">Monash University</option>
              <option value="University of Sydney">University of Sydney</option>
              <option value="UNSW">UNSW</option>
              <option value="University of Queensland">University of Queensland</option>
              <option value="Australian National University">Australian National University</option>
              <option value="Macquarie University">Macquarie University</option>
              <option value="University of Adelaide">University of Adelaide</option>
              <option value="University of Western Australia">University of Western Australia</option>
              <option value="Other">Other</option>
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label">Status</label>
            <select name="status" class="form-select" required>
              <option value="">Select status</option>
              <option value="Applied">Applied</option>
              <option value="Online Assessment Received">Online Assessment Received</option>
              <option value="Online Assessment Completed">Online Assessment Completed</option>
              <option value="Phone Interview Scheduled">Phone Interview Scheduled</option>
              <option value="Phone Interview Completed">Phone Interview Completed</option>
              <option value="Assessment Centre Invited">Assessment Centre Invited</option>
              <option value="Assessment Centre Completed">Assessment Centre Completed</option>
              <option value="Final Interview Scheduled">Final Interview Scheduled</option>
              <option value="Final Interview Completed">Final Interview Completed</option>
              <option value="Offered">Offered</option>
              <option value="Rejected - No Response">Rejected - No Response</option>
              <option value="Rejected - After Assessment">Rejected - After Assessment</option>
              <option value="Rejected - After Interview">Rejected - After Interview</option>
              <option value="Withdrawn">Withdrawn</option>
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label">Response Date (if applicable)</label>
            <input name="response_date" type="date" class="form-control">
          </div>
          <div class="col-md-4">
            <label class="form-label">Priority</label>
            <select name="priority" class="form-select">
              <option value="">Select priority</option>
              <option value="High">High</option>
              <option value="Medium">Medium</option>
              <option value="Low">Low</option>
            </select>
          </div>
          <div class="col-12">
            <label class="form-label">Notes</label>
            <textarea name="notes" class="form-control" rows="2" placeholder="Any additional notes about this application..."></textarea>
          </div>
          <div class="col-12">
            <button type="submit" class="btn btn-primary">Add Application</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Applications List -->
    <div class="card">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h4 class="card-title mb-0">Your Applications ({{ applications|length }})</h4>
          <div class="d-flex gap-2">
            <a href="/tracker/analytics" class="btn btn-outline-info btn-sm">
              <i class="bi bi-bar-chart me-1"></i>View Analytics
            </a>
            <a href="/tracker/export" class="btn btn-outline-secondary btn-sm">
              <i class="bi bi-download me-1"></i>Export CSV
            </a>
          </div>
        </div>

        {% if applications %}
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>Company</th>
                  <th>Role</th>
                  <th>University</th>
                  <th>Applied</th>
                  <th>WAM</th>
                  <th>Status</th>
                  <th>Response Time</th>
                  <th>Priority</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for app in applications %}
                <tr>
                  <td class="fw-medium">{{ app.company }}</td>
                  <td>{{ app.role }}</td>
                  <td class="small">{{ app.university if app.university else '-' }}</td>
                  <td>{{ app.application_date.strftime('%b %d, %Y') if app.application_date else 'N/A' }}</td>
                  <td>{{ app.wam if app.wam else '-' }}</td>
                  <td>
                    <div class="status-container" data-app-id="{{ app.id }}">
                      <span class="status-display badge 
                        {% if app.status == 'Offered' %}bg-success
                        {% elif 'Rejected' in app.status %}bg-danger
                        {% elif 'Interview' in app.status or 'Assessment' in app.status %}bg-warning
                        {% else %}bg-secondary
                        {% endif %}" onclick="editStatus({{ app.id }}, '{{ app.status }}')">
                        {{ app.status }}
                      </span>
                      <select class="status-edit form-select form-select-sm d-none" data-original-status="{{ app.status }}">
                        <option value="Applied" {{ 'selected' if app.status == 'Applied' else '' }}>Applied</option>
                        <option value="Online Assessment Received" {{ 'selected' if app.status == 'Online Assessment Received' else '' }}>Online Assessment Received</option>
                        <option value="Online Assessment Completed" {{ 'selected' if app.status == 'Online Assessment Completed' else '' }}>Online Assessment Completed</option>
                        <option value="Phone Interview Scheduled" {{ 'selected' if app.status == 'Phone Interview Scheduled' else '' }}>Phone Interview Scheduled</option>
                        <option value="Phone Interview Completed" {{ 'selected' if app.status == 'Phone Interview Completed' else '' }}>Phone Interview Completed</option>
                        <option value="Assessment Centre Invited" {{ 'selected' if app.status == 'Assessment Centre Invited' else '' }}>Assessment Centre Invited</option>
                        <option value="Assessment Centre Completed" {{ 'selected' if app.status == 'Assessment Centre Completed' else '' }}>Assessment Centre Completed</option>
                        <option value="Final Interview Scheduled" {{ 'selected' if app.status == 'Final Interview Scheduled' else '' }}>Final Interview Scheduled</option>
                        <option value="Final Interview Completed" {{ 'selected' if app.status == 'Final Interview Completed' else '' }}>Final Interview Completed</option>
                        <option value="Offered" {{ 'selected' if app.status == 'Offered' else '' }}>Offered</option>
                        <option value="Rejected - No Response" {{ 'selected' if app.status == 'Rejected - No Response' else '' }}>Rejected - No Response</option>
                        <option value="Rejected - After Assessment" {{ 'selected' if app.status == 'Rejected - After Assessment' else '' }}>Rejected - After Assessment</option>
                        <option value="Rejected - After Interview" {{ 'selected' if app.status == 'Rejected - After Interview' else '' }}>Rejected - After Interview</option>
                        <option value="Withdrawn" {{ 'selected' if app.status == 'Withdrawn' else '' }}>Withdrawn</option>
                      </select>
                    </div>
                  </td>
                  <td>
                    {% if app.response_date and app.application_date %}
                      {% set days_diff = (app.response_date - app.application_date).days %}
                      {{ days_diff }} day{{ 's' if days_diff != 1 else '' }}
                    {% else %}
                      Pending
                    {% endif %}
                  </td>
                  <td>
                    {% if app.priority %}
                      <span class="badge 
                        {% if app.priority == 'High' %}bg-danger
                        {% elif app.priority == 'Medium' %}bg-warning
                        {% else %}bg-info
                        {% endif %} bg-opacity-25 text-dark">
                        {{ app.priority }}
                      </span>
                    {% endif %}
                  </td>
                  <td>
                    <button class="btn btn-outline-danger btn-sm" onclick="deleteApplication({{ app.id }})">
                      <i class="bi bi-trash"></i>
                    </button>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <div class="text-center py-5">
            <div class="mb-4">
              <i class="bi bi-clipboard-check text-muted" style="font-size: 4rem;"></i>
            </div>
            <h5 class="fw-medium mb-3">No applications yet</h5>
            <p class="text-muted">Start tracking your graduate program applications to see your progress and get insights!</p>
          </div>
        {% endif %}
      </div>
    </div>

  {% else %}
    <div class="text-center py-5">
      <div class="mb-4">
        <i class="bi bi-person-lock text-primary" style="font-size: 4rem;"></i>
      </div>
      <h3 class="fw-medium mb-3">Account Required</h3>
      <p class="text-muted mb-4">Please log in with your Replit account to track your applications.</p>
      <button onclick="LoginWithReplit()" class="btn btn-primary btn-lg">
        <i class="bi bi-box-arrow-in-right me-2"></i>Login with Replit
      </button>
    </div>
    <script>
      function LoginWithReplit() {
        window.addEventListener("message", authComplete);
        var h = 500;
        var w = 350;
        var left = screen.width / 2 - w / 2;
        var top = screen.height / 2 - h / 2;

        var authWindow = window.open(
          "https://replit.com/auth_with_repl_site?domain=" + location.host,
          "_blank",
          "modal=yes, toolbar=no, location=no, directories=no, status=no, menubar=no, scrollbars=no, resizable=no, copyhistory=no, width=" +
            w +
            ", height=" +
            h +
            ", top=" +
            top +
            ", left=" +
            left
        );

        function authComplete(e) {
          if (e.data !== "auth_complete") {
            return;
          }

          window.removeEventListener("message", authComplete);
          authWindow.close();
          location.reload();
        }
      }
    </script>
  {% endif %}
</div>

<script>
function editStatus(appId, currentStatus) {
  const container = document.querySelector(`[data-app-id="${appId}"]`);
  const display = container.querySelector('.status-display');
  const select = container.querySelector('.status-edit');
  
  // Hide display, show select
  display.classList.add('d-none');
  select.classList.remove('d-none');
  select.focus();
  
  // Handle change
  select.onchange = function() {
    updateApplicationStatus(appId, this.value);
  };
  
  // Handle click outside or escape
  select.onblur = function() {
    cancelStatusEdit(container);
  };
  
  select.onkeydown = function(e) {
    if (e.key === 'Escape') {
      cancelStatusEdit(container);
    }
  };
}

function cancelStatusEdit(container) {
  const display = container.querySelector('.status-display');
  const select = container.querySelector('.status-edit');
  
  display.classList.remove('d-none');
  select.classList.add('d-none');
}

function updateApplicationStatus(appId, newStatus) {
  fetch(`/tracker/update/${appId}`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      status: newStatus
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      location.reload(); // Refresh to show updated status with correct badge color
    } else {
      alert('Failed to update status');
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Failed to update status');
  });
}

function editApplication(id) {
  // Quick edit for other fields - could expand this later
  const notes = prompt('Update notes:');
  if (notes !== null) {
    fetch(`/tracker/update/${id}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        notes: notes
      })
    })
    .then(() => location.reload());
  }
}

function deleteApplication(id) {
  if (confirm('Are you sure you want to delete this application?')) {
    fetch(`/tracker/delete/${id}`, {
      method: 'DELETE'
    }).then(() => {
      location.reload();
    });
  }
}
</script>
{% endblock %}
